<!DOCTYPE html>
<html>

<head>
    <title>Frame</title>
    <style type="text/css">
    * {
        cursor: none
    }
    
    html,
    body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        background-color: #000;
    }
    
    body {
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
    }
    </style>
</head>

<body>
    <script type="text/javascript" src="/js/libs/jquery-2.1.3.js"></script>
    <script type="text/javascript">
    var $body = $('body'),
        connected = false,
        domain,
        username,
        framename,
        frame_id;

    $.getJSON('http://localhost:7000/config', function(resp) {
        // resp should contain the username and root_domain
        domain = resp.root_domain;
        username = resp.owner;
        framename = resp.name;
        frame_id = resp._id.$oid;
        setInterval(check_connection, 5000);
        check_connection();
    });

    function check_connection() {
        if (!connected) {
            connect_ws(domain, frame_id);
        }
    }

    // initializes WebSocket connection
    function connect_ws(root_domain, frame_id) {
        console.log('init WebSocket connection for this frame ' + frame_id);
        var ws = new WebSocket("ws://" + root_domain + "/ws/" + frame_id);

        ws.onopen = function() {
            console.log('connection open');
            ws.send("connecting as " + frame_id);
            connected = true;
        };

        ws.onmessage = function(evt) {
            var data = JSON.parse(evt.data);
            console.log(data);
            if (data.url) {
                $body.animate({
                    'opacity': 0
                }, 1000, function() {
                    $body.css({
                        'background-image': 'url("' + data.url + '")'
                    });
                    $body.animate({
                        'opacity': 1
                    }, 1000);
                });
            }
        };

        ws.onclose = function(evt) {
            console.log('connection closed');
            connected = false;
        };
    }
    </script>
</body>

</html>
